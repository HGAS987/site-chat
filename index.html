<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nous — Chat TV Girl (Firebase)</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{--pink:#ff71ce;--blue:#67d0ff;--card-radius:20px}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Space Grotesk','Montserrat',system-ui; background:radial-gradient(ellipse at 10% 10%, rgba(103,208,255,0.06) 0%, transparent 20%), radial-gradient(ellipse at 90% 90%, rgba(255,113,206,0.04) 0%, transparent 20%), #0f0c29;color:#fff;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:980px;height:86vh;display:grid;grid-template-columns:340px 1fr;gap:20px}
    .panel{background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.06));border-radius:var(--card-radius);padding:18px;backdrop-filter:blur(6px)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:54px;height:54px;border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:20px;background:linear-gradient(135deg,var(--pink),var(--blue));color:#080816}
    .profile{display:flex;align-items:center;gap:12px;margin:18px 0}
    .avatar{width:56px;height:56px;border-radius:50%;background:conic-gradient(from 180deg at 50% 50%,var(--pink),var(--blue));display:grid;place-items:center;font-weight:700;color:#080816}
    .rooms{margin-top:8px}
    .chat{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border-radius:var(--card-radius);display:flex;flex-direction:column;overflow:hidden}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .chat-body{flex:1;padding:20px;overflow:auto;display:flex;flex-direction:column;gap:12px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><text x="-10" y="14" fill="rgba(255,255,255,0.02)" transform="rotate(-25)">TV GIRL</text></svg>');background-repeat:repeat}
    .bubble{max-width:66%;padding:12px 14px;border-radius:16px;position:relative;box-shadow:0 6px 18px rgba(2,6,23,0.45)}
    .bubble.me{align-self:flex-end;background:linear-gradient(90deg,var(--pink),#ffb3e6);color:#221;border-bottom-right-radius:6px}
    .bubble.them{align-self:flex-start;background:linear-gradient(90deg,#9be7ff,var(--blue));color:#06202e;border-bottom-left-radius:6px}
    .time{display:block;font-size:11px;color:rgba(0,0,0,0.5);margin-top:6px}
    .chat-footer{padding:14px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:10px;align-items:center}
    .input{flex:1;background:transparent;border:1px solid rgba(255,255,255,0.06);padding:12px;border-radius:14px;color:var(--muted);outline:none;color:#fff}
    .btn{background:linear-gradient(90deg,var(--pink),var(--blue));padding:10px 14px;border-radius:12px;border:none;color:#07061a;font-weight:700;cursor:pointer}
    .auth{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .field input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    .small{font-size:13px;color:rgba(255,255,255,0.6)}
    @media (max-width:820px){.wrap{grid-template-columns:1fr;height:92vh}}
  </style>
</head>
<body>

  <div class="wrap">
    <aside class="panel">
      <div class="brand">
        <div class="logo">TV</div>
        <div>
          <h1>Nous</h1>
          <p class="small">un petit espace privé ✨</p>
        </div>
      </div>

      <div class="profile" id="profileArea">
        <div class="avatar" id="miniAvatar">A</div>
        <div>
          <div id="miniName">Invité</div>
          <div class="small" id="miniEmail">Non connecté</div>
        </div>
      </div>

      <div id="authBox">
        <div class="small">Crée un compte ou connecte-toi</div>
        <div class="auth">
          <input id="displayName" placeholder="Ton pseudo (affiché)" />
          <input id="email" placeholder="Email" />
          <input id="password" type="password" placeholder="Mot de passe" />
          <div style="display:flex;gap:8px">
            <button id="signupBtn" class="btn" style="flex:1">S'inscrire</button>
            <button id="signinBtn" class="btn" style="flex:1">Se connecter</button>
          </div>
          <button id="signoutBtn" class="btn" style="display:none;margin-top:6px">Se déconnecter</button>
        </div>
      </div>

      <div style="margin-top:18px;font-size:13px;color:rgba(255,255,255,0.6)">
        Design TV Girl • Messages en temps réel via Firebase Realtime Database.
      </div>
    </aside>

    <main class="chat" role="region" aria-label="Chat principal">
      <div class="chat-header">
        <h2>Discussion privée</h2>
        <div class="small" id="statusTxt">Non connecté</div>
      </div>

      <div class="chat-body" id="chatBody">
        <!-- messages here -->
      </div>

      <div class="chat-footer">
        <input id="messageInput" class="input" placeholder="Ecris un message..." aria-label="Message" />
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>
    </main>
  </div>

  <!-- Firebase modular SDK (CDN) -->
  <script type="module">
    // --- IMPORTS (Firebase v9 modular via CDN) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      serverTimestamp,
      query,
      orderByChild,
      limitToLast
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // --- TA CONFIGURATION (déjà fournie) ---
    const firebaseConfig = {
      apiKey: "AIzaSyANXzFCNDTrpMiv5nHd5shfXbrZ64VGzDM",
      authDomain: "chat-tv-girl-864fe.firebaseapp.com",
      databaseURL: "https://chat-tv-girl-864fe-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "chat-tv-girl-864fe",
      storageBucket: "chat-tv-girl-864fe.firebasestorage.app",
      messagingSenderId: "797956573850",
      appId: "1:797956573850:web:79f800acafb558542fed23"
    };

    // --- INITIALISATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- UI REFERENCES ---
    const displayNameInput = document.getElementById('displayName');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signupBtn');
    const signinBtn = document.getElementById('signinBtn');
    const signoutBtn = document.getElementById('signoutBtn');
    const miniName = document.getElementById('miniName');
    const miniEmail = document.getElementById('miniEmail');
    const miniAvatar = document.getElementById('miniAvatar');
    const statusTxt = document.getElementById('statusTxt');

    const chatBody = document.getElementById('chatBody');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // --- AUTH: Inscription ---
    signupBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const display = displayNameInput.value.trim() || email.split('@')[0];
      if (!email || !password) { alert('Email et mot de passe requis'); return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        // On met à jour le displayName de l'utilisateur
        await updateProfile(cred.user, { displayName: display });
        // clear inputs
        passwordInput.value = '';
      } catch (err) {
        alert('Erreur inscription: ' + err.message);
      }
    });

    // --- AUTH: Connexion ---
    signinBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) { alert('Email et mot de passe requis'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        passwordInput.value = '';
      } catch (err) {
        alert('Erreur connexion: ' + err.message);
      }
    });

    // --- DECONNEXION ---
    signoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    // --- OBSERVER AUTH ---
    let messagesRefUnsub = null;
    onAuthStateChanged(auth, user => {
      if (user) {
        const name = user.displayName || (user.email ? user.email.split('@')[0] : 'Utilisateur');
        miniName.textContent = name;
        miniEmail.textContent = user.email;
        miniAvatar.textContent = name.slice(0,1).toUpperCase();
        statusTxt.textContent = 'Connecté';
        signoutBtn.style.display = 'block';
        // cache display name in UI input (facultatif)
        displayNameInput.value = name;

        // start listening to messages
        startListeningMessages();
      } else {
        miniName.textContent = 'Invité';
        miniEmail.textContent = 'Non connecté';
        miniAvatar.textContent = 'A';
        statusTxt.textContent = 'Non connecté';
        signoutBtn.style.display = 'none';
        stopListeningMessages();
        chatBody.innerHTML = ''; // optionnel : vider lors de déconnexion
      }
    });

    // --- ENVOI MESSAGE ---
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    async function sendMessage() {
      const txt = messageInput.value.trim();
      const user = auth.currentUser;
      if (!user) { alert('Connecte-toi pour envoyer un message'); return; }
      if (!txt) return;
      const payload = {
        fromUid: user.uid,
        fromName: user.displayName || user.email.split('@')[0],
        text: txt,
        ts: serverTimestamp()
      };
      try {
        const messagesRef = ref(db, 'messages');
        await push(messagesRef, payload);
        messageInput.value = '';
      } catch (err) {
        console.error('Erreur envoi message', err);
        alert('Impossible d\'envoyer le message : ' + err.message);
      }
    }

    // --- ECOUTE MESSAGES EN TEMPS RÉEL ---
    let messagesQuery = null;
    function startListeningMessages() {
      // On écoute les 200 derniers messages (ajuste si tu veux)
      const q = query(ref(db, 'messages'), orderByChild('ts'), limitToLast(200));
      messagesQuery = q;
      onChildAdded(q, snapshot => {
        const m = snapshot.val();
        // ts peut être un objet serverTimestamp initialement; on convertit proprement
        let timeTxt = '';
        if (m && m.ts) {
          // si c'est un nombre (timestamp), ok. Sinon on place l'heure actuelle.
          try {
            const t = typeof m.ts === 'number' ? new Date(m.ts) : new Date();
            timeTxt = t.toLocaleString();
          } catch (e) {
            timeTxt = new Date().toLocaleString();
          }
        }
        appendMessageToUI(m.fromName, m.text, timeTxt, m.fromUid === (auth.currentUser && auth.currentUser.uid));
      });
    }

    function stopListeningMessages() {
      // Firebase Realtime onChildAdded ne donne pas d'unsubscribe direct via query,
      // mais onAuthStateChanged + page unload feront le travail. Ici, on peut simplement
      // laisser l'écoute ; pour plus propre on pourrait stocker la référence et off().
      // (La page unique et GitHub Pages n'a pas besoin d'un off explicite dans ce petit projet.)
    }

    // --- UI : insertion message ---
    function appendMessageToUI(from, text, time, isMe) {
      const el = document.createElement('div');
      el.className = 'bubble ' + (isMe ? 'me' : 'them');
      el.innerHTML = `<div style="font-weight:600">${escapeHtml(from)}</div><div>${escapeHtml(text)}</div><span class="time">${escapeHtml(time)}</span>`;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>\"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[c]; });
    }

    // --- AU CHARGEMENT, on récupère quelques messages historiques (facultatif) ---
    // (les messages s'afficheront automatiquement via onChildAdded)
  </script>
</body>
</html>
