<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nous — Chat TV Girl (Firebase)</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{--pink:#ff71ce;--blue:#67d0ff;--card-radius:20px}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Space Grotesk','Montserrat',system-ui; background:radial-gradient(ellipse at 10% 10%, rgba(103,208,255,0.06) 0%, transparent 20%), radial-gradient(ellipse at 90% 90%, rgba(255,113,206,0.04) 0%, transparent 20%), #0f0c29;color:#fff;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:980px;height:86vh;display:grid;grid-template-columns:340px 1fr;gap:20px}
    .panel{background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.06));border-radius:var(--card-radius);padding:18px;backdrop-filter:blur(6px)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:54px;height:54px;border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:20px;background:linear-gradient(135deg,var(--pink),var(--blue));color:#080816}
    .profile{display:flex;align-items:center;gap:12px;margin:18px 0}
    .avatar{width:56px;height:56px;border-radius:50%;background:conic-gradient(from 180deg at 50% 50%,var(--pink),var(--blue));display:grid;place-items:center;font-weight:700;color:#080816}
    .rooms{margin-top:8px}
    .chat{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border-radius:var(--card-radius);display:flex;flex-direction:column;overflow:hidden}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .chat-body{flex:1;padding:20px;overflow:auto;display:flex;flex-direction:column;gap:12px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><text x="-10" y="14" fill="rgba(255,255,255,0.02)" transform="rotate(-25)">TV GIRL</text></svg>');background-repeat:repeat}
    .bubble{max-width:66%;padding:12px 14px;border-radius:16px;position:relative;box-shadow:0 6px 18px rgba(2,6,23,0.45)}
    .bubble.me{align-self:flex-end;background:linear-gradient(90deg,var(--pink),#ffb3e6);color:#221;border-bottom-right-radius:6px}
    .bubble.them{align-self:flex-start;background:linear-gradient(90deg,#9be7ff,var(--blue));color:#06202e;border-bottom-left-radius:6px}
    .time{display:block;font-size:11px;color:rgba(0,0,0,0.5);margin-top:6px}
    .chat-footer{padding:14px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:10px;align-items:center}
    .input{flex:1;background:transparent;border:1px solid rgba(255,255,255,0.06);padding:12px;border-radius:14px;color:var(--muted);outline:none;color:#fff}
    .btn{background:linear-gradient(90deg,var(--pink),var(--blue));padding:10px 14px;border-radius:12px;border:none;color:#07061a;font-weight:700;cursor:pointer}
    .auth{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .field input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    .small{font-size:13px;color:rgba(255,255,255,0.6)}
    @media (max-width:820px){.wrap{grid-template-columns:1fr;height:92vh}}
  </style>
</head>
<body>

  <div class="wrap">
    <aside class="panel">
      <div class="brand">
        <div class="logo">TV</div>
        <div>
          <h1>Nous</h1>
          <p class="small">un petit espace privé ✨</p>
        </div>
      </div>

      <div class="profile" id="profileArea">
        <div class="avatar" id="miniAvatar">A</div>
        <div>
          <div id="miniName">Invité</div>
          <div class="small" id="miniEmail">Non connecté</div>
        </div>
      </div>

      <div id="authBox">
        <div class="small">Crée un compte ou connecte-toi</div>
        <div class="auth">
          <input id="displayName" placeholder="Ton pseudo (affiché)" />
          <input id="email" placeholder="Email" />
          <input id="password" type="password" placeholder="Mot de passe" />
          <div style="display:flex;gap:8px">
            <button id="signupBtn" class="btn" style="flex:1">S'inscrire</button>
            <button id="signinBtn" class="btn" style="flex:1">Se connecter</button>
          </div>
          <button id="signoutBtn" class="btn" style="display:none;margin-top:6px">Se déconnecter</button>
        </div>
      </div>

      <div style="margin-top:18px;font-size:13px;color:rgba(255,255,255,0.6)">
        Design TV Girl • Messages en temps réel via Firebase Realtime Database.
      </div>
    </aside>

    <main class="chat" role="region" aria-label="Chat principal">
      <div class="chat-header">
        <h2>Discussion privée</h2>
        <div class="small" id="statusTxt">Non connecté</div>
      </div>

      <div class="chat-body" id="chatBody">
        <!-- messages here -->
      </div>

      <div class="chat-footer">
        <input id="messageInput" class="input" placeholder="Ecris un message..." aria-label="Message" />
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>
    </main>
  </div>

  <!-- Firebase modular SDK (CDN) -->
  <script type="module">
    // --- IMPORTS (Firebase v9 modular via CDN) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      serverTimestamp,
      query,
      orderByChild,
      limitToLast
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // --- TA CONFIGURATION (déjà fournie) ---
    const firebaseConfig = {
      apiKey: "AIzaSyANXzFCNDTrpMiv5nHd5shfXbrZ64VGzDM",
      authDomain: "chat-tv-girl-864fe.firebaseapp.com",
      databaseURL: "https://chat-tv-girl-864fe-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "chat-tv-girl-864fe",
      storageBucket: "chat-tv-girl-864fe.firebasestorage.app",
      messagingSenderId: "797956573850",
      appId: "1:797956573850:web:79f800acafb558542fed23"
    };

    // --- INITIALISATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- UI REFERENCES ---
    const displayNameInput = document.getElementById('displayName');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signupBtn');
    const signinBtn = document.getElementById('signinBtn');
    const signoutBtn = document.getElementById('signoutBtn');
    const miniName = document.getElementById('miniName');
    const miniEmail = document.getElementById('miniEmail');
    const miniAvatar = document.getElementById('miniAvatar');
    const statusTxt = document.getElementById('statusTxt');

    const chatBody = document.getElementById('chatBody');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // --- AUTH: Inscription ---
    signupBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const display = displayNameInput.value.trim() || email.split('@')[0];
      if (!email || !password) { alert('Email et mot de passe requis'); return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        // On met à jour le displayName de l'utilisateur
        await updateProfile(cred.user, { displayName: display });
        // clear inputs
        passwordInput.value = '';
      } catch (err) {
        alert('Erreur inscription: ' + err.message);
      }
    });

    // --- AUTH: Connexion ---
    signinBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) { alert('Email et mot de passe requis'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        passwordInput.value = '';
      } catch (err) {
        alert('Erreur connexion: ' + err.message);
      }
    });

    // --- DECONNEXION ---
    signoutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    // --- OBSERVER AUTH ---
    let messagesRefUnsub = null;
    onAuthStateChanged(auth, user => {
      if (user) {
        const name = user.displayName || (user.email ? user.email.split('@')[0] : 'Utilisateur');
        miniName.textContent = name;
        miniEmail.textContent = user.email;
        miniAvatar.textContent = name.slice(0,1).toUpperCase();
        statusTxt.textContent = 'Connecté';
        signoutBtn.style.display = 'block';
        // cache display name in UI input (facultatif)
        displayNameInput.value = name;

        // start listening to messages
        startListeningMessages();
      } else {
        miniName.textContent = 'Invité';
        miniEmail.textContent = 'Non connecté';
        miniAvatar.textContent = 'A';
        statusTxt.textContent = 'Non connecté';
        signoutBtn.style.display = 'none';
        stopListeningMessages();
        chatBody.innerHTML = ''; // optionnel : vider lors de déconnexion
      }
    });

    // --- ENVOI MESSAGE ---
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    async function sendMessage() {
      const txt = messageInput.value.trim();
      const user = auth.currentUser;
      if (!user) { alert('Connecte-toi pour envoyer un message'); return; }
      if (!txt) return;
      const payload = {
        fromUid: user.uid,
        fromName: user.displayName || user.email.split('@')[0],
        text: txt,
        ts: serverTimestamp()
      };
      try {
        const messagesRef = ref(db, 'messages');
        await push(messagesRef, payload);
        messageInput.value = '';
      } catch (err) {
        console.error('Erreur envoi message', err);
        alert('Impossible d\'envoyer le message : ' + err.message);
      }
    }

    // --- ECOUTE MESSAGES EN TEMPS RÉEL ---
    let messagesQuery = null;
    function startListeningMessages() {
      // On écoute les 200 derniers messages (ajuste si tu veux)
      const q = query(ref(db, 'messages'), orderByChild('ts'), limitToLast(200));
      messagesQuery = q;
      onChildAdded(q, snapshot => {
        const m = snapshot.val();
        // ts peut être un objet serverTimestamp initialement; on convertit proprement
        let timeTxt = '';
        if (m && m.ts) {
          // si c'est un nombre (timestamp), ok. Sinon on place l'heure actuelle.
          try {
            const t = typeof m.ts === 'number' ? new Date(m.ts) : new Date();
            timeTxt = t.toLocaleString();
          } catch (e) {
            timeTxt = new Date().toLocaleString();
          }
        }
        appendMessageToUI(m.fromName, m.text, timeTxt, m.fromUid === (auth.currentUser && auth.currentUser.uid));
      });
    }

    function stopListeningMessages() {
      // Firebase Realtime onChildAdded ne donne pas d'unsubscribe direct via query,
      // mais onAuthStateChanged + page unload feront le travail. Ici, on peut simplement
      // laisser l'écoute ; pour plus propre on pourrait stocker la référence et off().
      // (La page unique et GitHub Pages n'a pas besoin d'un off explicite dans ce petit projet.)
    }

    // --- UI : insertion message ---
    function appendMessageToUI(from, text, time, isMe) {
      const el = document.createElement('div');
      el.className = 'bubble ' + (isMe ? 'me' : 'them');
      el.innerHTML = `<div style="font-weight:600">${escapeHtml(from)}</div><div>${escapeHtml(text)}</div><span class="time">${escapeHtml(time)}</span>`;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>\"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[c]; });
    }

    // --- AU CHARGEMENT, on récupère quelques messages historiques (facultatif) ---
    // (les messages s'afficheront automatiquement via onChildAdded)
  </script>
</body>
</html>
// firebase-config.js
export const firebaseConfig = {
  apiKey: "AIzaSyANXzFCNDTrpMiv5nHd5shfXbrZ64VGzDM",
  authDomain: "chat-tv-girl-864fe.firebaseapp.com",
  databaseURL: "https://chat-tv-girl-864fe-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-tv-girl-864fe",
  storageBucket: "chat-tv-girl-864fe.firebasestorage.app",
  messagingSenderId: "797956573850",
  appId: "1:797956573850:web:79f800acafb558542fed23"
};
/* style.css - fond romantique & styles partagés */
:root{
  --pink: #ff8acb;
  --blue: #8fe7ff;
  --card-radius: 18px;
  --muted: rgba(255,255,255,0.7);
}

/* Reset minimal */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family: 'Space Grotesk', 'Montserrat', system-ui;padding:0}

/* Romantique, pastel, plus lumineux */
body{
  background:
    radial-gradient(1000px 400px at 10% 10%, rgba(255,138,203,0.06), transparent 15%),
    radial-gradient(900px 400px at 90% 90%, rgba(143,231,255,0.05), transparent 15%),
    linear-gradient(180deg, #fff0f6 0%, #f0fbff 100%);
  color:#111;
  -webkit-font-smoothing:antialiased;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:28px;
  min-height:100vh;
}

/* soft vignette and subtle paper texture */
body::after{
  content:"";
  position:fixed; inset:0;
  background: radial-gradient(ellipse at center, rgba(255,255,255,0.02), transparent 30%), linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  pointer-events:none;
  mix-blend-mode:overlay;
}

/* container used by pages */
.container{
  width:100%;
  max-width:980px;
  display:grid;
  grid-template-columns:340px 1fr;
  gap:20px;
  align-items:stretch;
  height:86vh;
}

/* panel & chat card look */
.panel, .chat{
  border-radius:var(--card-radius);
  background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.92));
  box-shadow: 0 12px 30px rgba(11,12,25,0.08);
  padding:18px;
}

/* header & logo */
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;font-weight:800;font-size:20px;background:linear-gradient(135deg,var(--pink),var(--blue));color:#07101b}

/* profile */
.profile{display:flex;gap:12px;align-items:center;margin:14px 0}
.avatar{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;font-weight:700;color:#07101b;background:conic-gradient(from 180deg,var(--pink),var(--blue))}

/* input and buttons */
input[type="text"], input[type="email"], input[type="password"]{
  width:100%;padding:12px;border-radius:12px;border:1px solid rgba(10,10,10,0.06);background:transparent;font-size:15px;
}
.btn{
  background:linear-gradient(90deg,var(--pink),var(--blue));
  color:#07101b;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;
}

/* chat body */
.chat-header{display:flex;align-items:center;justify-content:space-between;padding-bottom:8px}
.chat-body{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:12px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="220"><text x="-10" y="14" fill="rgba(7,16,27,0.02)" transform="rotate(-25)">TV GIRL</text></svg>');background-repeat:repeat}
.chat-footer{display:flex;gap:10px;padding-top:10px;border-top:1px solid rgba(11,12,25,0.03)}
.bubble{max-width:66%;padding:12px;border-radius:16px}
.me{align-self:flex-end;background:linear-gradient(90deg,var(--pink),#ffd6ef);color:#07101b}
.them{align-self:flex-start;background:linear-gradient(90deg,#ccefff,var(--blue));color:#07101b}
.time{display:block;font-size:11px;color:rgba(7,16,27,0.45);margin-top:6px}

/* login card centered (used on login page) */
.login-wrap{display:grid;place-items:center;height:100vh;padding:28px}
.login-card{width:100%;max-width:420px;background:linear-gradient(180deg,rgba(255,255,255,0.95),#fff);padding:24px;border-radius:18px;box-shadow:0 18px 50px rgba(11,12,25,0.08);text-align:center}
.login-card h2{margin:6px 0 12px 0}
.small{font-size:13px;color:rgba(7,16,27,0.5)}

/* overlay animation (success reveal) */
#launchOverlay{
  position:fixed;inset:0;z-index:9999;pointer-events:none;
  background: radial-gradient(circle at 50% 35%, rgba(255,255,255,0.55), transparent 20%), linear-gradient(180deg, rgba(255,138,203,0.12), rgba(143,231,255,0.08));
  clip-path: circle(0% at 50% 35%);
  transition: clip-path 700ms cubic-bezier(.2,.9,.2,1), opacity 500ms;
  opacity:0;
  display:grid;place-items:center;
}
#launchOverlay.open{
  clip-path: circle(150% at 50% 35%);
  opacity:1;
}

/* tiny hearts animation inside overlay */
.heart{
  width:70px;height:70px;border-radius:20px;display:grid;place-items:center;font-size:32px;transform:scale(0.8);animation:pop 700ms ease;
}
@keyframes pop{0%{transform:scale(0.3);opacity:0}60%{transform:scale(1.12);opacity:1}100%{transform:scale(1);opacity:1}}

/* responsive */
@media (max-width:820px){
  .container{grid-template-columns:1fr;height:100vh}
  .panel{order:2}
  .chat{order:1}
}
<!-- login.html (ou index.html si tu veux la mettre comme page d'accueil) -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connexion — Nous</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="login-wrap">
    <div class="login-card" id="loginCard">
      <div class="brand" style="justify-content:center">
        <div class="logo">TV</div>
      </div>
      <h2>Bienvenue</h2>
      <div class="small">Connecte-toi ou crée un compte pour accéder à votre espace privé.</div>

      <div style="margin-top:14px;text-align:left">
        <label class="small">Pseudo (affiché)</label>
        <input id="displayName" type="text" placeholder="Ex : Loulou" />

        <label class="small" style="margin-top:8px;display:block">Email</label>
        <input id="email" type="email" placeholder="email@exemple.com" />

        <label class="small" style="margin-top:8px;display:block">Mot de passe</label>
        <input id="password" type="password" placeholder="8 caractères min" />

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="signupBtn" class="btn" style="flex:1">S'inscrire</button>
          <button id="signinBtn" class="btn" style="flex:1">Se connecter</button>
        </div>

        <div style="margin-top:10px;text-align:center">
          <small class="small">Après connexion, une jolie ouverture vous mènera au chat ✨</small>
        </div>
      </div>
    </div>
  </div>

  <div id="launchOverlay" aria-hidden="true">
    <div class="heart">💖</div>
  </div>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const displayNameInput = document.getElementById('displayName');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signupBtn');
    const signinBtn = document.getElementById('signinBtn');
    const overlay = document.getElementById('launchOverlay');
    const loginCard = document.getElementById('loginCard');

    async function showSuccessAndGo(){
      // belle animation puis redirection
      overlay.classList.add('open');
      // empêche tout clic
      loginCard.style.pointerEvents = 'none';
      setTimeout(()=> {
        // redirection vers la page de chat
        window.location.href = './chat.html';
      }, 780); // délai = même durée que l'animation CSS
    }

    signupBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const display = displayNameInput.value.trim() || (email.split('@')[0] || 'Utilisateur');
      if (!email || !password) { alert('Email et mot de passe requis'); return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName: display });
        // Success animation + redirect
        showSuccessAndGo();
      } catch (err) {
        alert('Erreur inscription: ' + err.message);
      }
    });

    signinBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) { alert('Email et mot de passe requis'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        // Success animation + redirect
        showSuccessAndGo();
      } catch (err) {
        alert('Erreur connexion: ' + err.message);
      }
    });

    // Si déjà connecté -> on redirige directement sans l'animation
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    onAuthStateChanged(auth, user => {
      if (user) {
        // connecté (ex : rechargement), va directement au chat
        window.location.href = './chat.html';
      }
    });
  </script>
</body>
</html>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat — Nous</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="container">
    <aside class="panel">
      <div class="brand">
        <div class="logo">TV</div>
        <div>
          <h1>Nous</h1>
          <div class="small">espace privé</div>
        </div>
      </div>

      <div class="profile">
        <div class="avatar" id="miniAvatar">A</div>
        <div>
          <div id="miniName">Invité</div>
          <div class="small" id="miniEmail">Non connecté</div>
        </div>
      </div>

      <div style="margin-top:8px">
        <button id="signoutBtn" class="btn" style="width:100%;">Se déconnecter</button>
      </div>

      <div style="margin-top:18px;font-size:13px;color:rgba(7,16,27,0.55)">
        Design TV Girl • Chat en temps réel via Firebase.
      </div>
    </aside>

    <main class="chat" role="region" aria-label="Chat principal">
      <div class="chat-header">
        <h2>Discussion privée</h2>
        <div class="small" id="statusTxt">Connexion...</div>
      </div>

      <div class="chat-body" id="chatBody"></div>

      <div class="chat-footer">
        <input id="messageInput" class="input" placeholder="Ecris un message..." aria-label="Message" />
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>
    </main>
  </div>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      serverTimestamp,
      query,
      orderByChild,
      limitToLast
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const miniName = document.getElementById('miniName');
    const miniEmail = document.getElementById('miniEmail');
    const miniAvatar = document.getElementById('miniAvatar');
    const statusTxt = document.getElementById('statusTxt');
    const chatBody = document.getElementById('chatBody');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const signoutBtn = document.getElementById('signoutBtn');

    // Redirige vers login si pas connecté
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = './login.html';
        return;
      }
      // utilisateur connecté -> initialisation UI
      const name = user.displayName || (user.email ? user.email.split('@')[0] : 'Utilisateur');
      miniName.textContent = name;
      miniEmail.textContent = user.email;
      miniAvatar.textContent = name.slice(0,1).toUpperCase();
      statusTxt.textContent = 'Connecté';
      startListeningMessages();
    });

    // Envoi de message
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    async function sendMessage(){
      const txt = messageInput.value.trim();
      const user = auth.currentUser;
      if (!user) { alert('Connecte-toi pour envoyer un message'); return; }
      if (!txt) return;
      const payload = {
        fromUid: user.uid,
        fromName: user.displayName || (user.email.split('@')[0]),
        text: txt,
        ts: serverTimestamp()
      };
      try {
        const messagesRef = ref(db, 'messages');
        await push(messagesRef, payload);
        messageInput.value = '';
      } catch (err) {
        console.error(err);
        alert('Erreur envoi: ' + err.message);
      }
    }

    // Ecoute en temps réel
    function startListeningMessages(){
      const q = query(ref(db, 'messages'), orderByChild('ts'), limitToLast(300));
      onChildAdded(q, snapshot => {
        const m = snapshot.val();
        let timeTxt = '';
        try {
          const t = m && m.ts && typeof m.ts === 'number' ? new Date(m.ts) : new Date();
          timeTxt = t.toLocaleString();
        } catch(e){
          timeTxt = new Date().toLocaleString();
        }
        appendMessage(m.fromName, m.text, timeTxt, m.fromUid === (auth.currentUser && auth.currentUser.uid));
      });
    }

    function appendMessage(from, text, time, isMe){
      const el = document.createElement('div');
      el.className = 'bubble ' + (isMe ? 'me' : 'them');
      el.innerHTML = `<div style="font-weight:600">${escapeHtml(from)}</div><div>${escapeHtml(text)}</div><span class="time">${escapeHtml(time)}</span>`;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    function escapeHtml(s){
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
    }

    // Deconnexion
    signoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      // redirection gérée par onAuthStateChanged
    });
  </script>
</body>
</html>
