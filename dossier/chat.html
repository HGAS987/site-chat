<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat — Nous</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="container">
    <aside class="panel">
      <div class="brand">
        <div class="logo">TV</div>
        <div>
          <h1>Nous</h1>
          <div class="small">espace privé</div>
        </div>
      </div>

      <div class="profile">
        <div class="avatar" id="miniAvatar">A</div>
        <div>
          <div id="miniName">Invité</div>
          <div class="small" id="miniEmail">Non connecté</div>
        </div>
      </div>

      <div style="margin-top:8px">
        <button id="signoutBtn" class="btn" style="width:100%;">Se déconnecter</button>
      </div>

      <div style="margin-top:18px;font-size:13px;color:rgba(7,16,27,0.55)">
        Design TV Girl • Chat en temps réel via Firebase.
      </div>
    </aside>

    <main class="chat" role="region" aria-label="Chat principal">
      <div class="chat-header">
        <h2>Discussion privée</h2>
        <div class="small" id="statusTxt">Connexion...</div>
      </div>

      <div class="chat-body" id="chatBody"></div>

      <div class="chat-footer">
        <input id="messageInput" class="input" placeholder="Ecris un message..." aria-label="Message" />
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>
    </main>
  </div>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      serverTimestamp,
      query,
      orderByChild,
      limitToLast
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const miniName = document.getElementById('miniName');
    const miniEmail = document.getElementById('miniEmail');
    const miniAvatar = document.getElementById('miniAvatar');
    const statusTxt = document.getElementById('statusTxt');
    const chatBody = document.getElementById('chatBody');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const signoutBtn = document.getElementById('signoutBtn');

    // Redirige vers login si pas connecté
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = './login.html';
        return;
      }
      // utilisateur connecté -> initialisation UI
      const name = user.displayName || (user.email ? user.email.split('@')[0] : 'Utilisateur');
      miniName.textContent = name;
      miniEmail.textContent = user.email;
      miniAvatar.textContent = name.slice(0,1).toUpperCase();
      statusTxt.textContent = 'Connecté';
      startListeningMessages();
    });

    // Envoi de message
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    async function sendMessage(){
      const txt = messageInput.value.trim();
      const user = auth.currentUser;
      if (!user) { alert('Connecte-toi pour envoyer un message'); return; }
      if (!txt) return;
      const payload = {
        fromUid: user.uid,
        fromName: user.displayName || (user.email.split('@')[0]),
        text: txt,
        ts: serverTimestamp()
      };
      try {
        const messagesRef = ref(db, 'messages');
        await push(messagesRef, payload);
        messageInput.value = '';
      } catch (err) {
        console.error(err);
        alert('Erreur envoi: ' + err.message);
      }
    }

    // Ecoute en temps réel
    function startListeningMessages(){
      const q = query(ref(db, 'messages'), orderByChild('ts'), limitToLast(300));
      onChildAdded(q, snapshot => {
        const m = snapshot.val();
        let timeTxt = '';
        try {
          const t = m && m.ts && typeof m.ts === 'number' ? new Date(m.ts) : new Date();
          timeTxt = t.toLocaleString();
        } catch(e){
          timeTxt = new Date().toLocaleString();
        }
        appendMessage(m.fromName, m.text, timeTxt, m.fromUid === (auth.currentUser && auth.currentUser.uid));
      });
    }

    function appendMessage(from, text, time, isMe){
      const el = document.createElement('div');
      el.className = 'bubble ' + (isMe ? 'me' : 'them');
      el.innerHTML = `<div style="font-weight:600">${escapeHtml(from)}</div><div>${escapeHtml(text)}</div><span class="time">${escapeHtml(time)}</span>`;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    function escapeHtml(s){
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
    }

    // Deconnexion
    signoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      // redirection gérée par onAuthStateChanged
    });
  </script>
</body>
</html>
